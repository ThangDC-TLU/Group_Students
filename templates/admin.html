<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang quản trị</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b1020; --card:#0f172a; --muted:#8ea0bf; --primary:#3b82f6; --primary-600:#2563eb;
      --ring:rgba(59,130,246,.35); --border:#1f2a44; --text:#e9edf5; --shadow:0 10px 30px rgba(0,0,0,.4);
      --tab:#111a30; --tab-active:#17213a; --ok:#16a34a; --err:#dc2626;
    }
    @media (prefers-color-scheme: light) {
      :root{ --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#55627a; --border:#e5e7ef; --shadow:0 8px 22px rgba(23,30,60,.08);
             --tab:#f2f4fa; --tab-active:#e9ecf6; }
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .bar .title{font-weight:800;font-size:20px}
    .btn{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--tab);color:var(--text);cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .tabs{display:flex;gap:8px;background:var(--tab);padding:6px;border-radius:12px;margin:10px 0 18px;border:1px solid var(--border)}
    .tab-btn{flex:1;padding:10px;border-radius:8px;border:0;background:transparent;color:var(--muted);font-weight:700;cursor:pointer}
    .tab-btn[aria-selected="true"]{background:var(--tab-active);color:var(--text)}
    .panel{display:none}
    .panel.active{display:block}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{background:var(--tab)}
    .grid{display:grid;grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:var(--shadow)}
    .row{margin-bottom:12px}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)}
    .muted{color:var(--muted);font-size:13px}
    .msg{margin-top:10px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .hint{font-size:12px;color:var(--muted);margin-top:4px}
    .flex{display:flex;gap:8px;align-items:center}
    .right{justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="title">Trang quản trị</div>
      <div class="flex">
        <label>Dataset:</label>
        <select id="datasetSelect">
          <option value="data">64HTTT1 (data.csv)</option>
          <option value="data_h2">64HTTT2 (data_h2.csv)</option>
        </select>
        <button class="btn" onclick="goHome()">Trang login</button>
        <button class="btn" onclick="logout()">Đăng xuất</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <button id="tab-students" class="tab-btn" role="tab" aria-selected="true" aria-controls="panel-students">Sinh viên</button>
      <button id="tab-group" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-group">Chia nhóm</button>
      <button id="tab-result" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-result">Kết quả</button>
    </div>

    <!-- STUDENTS -->
    <section id="panel-students" class="panel active">
      <div class="card flex" style="justify-content:space-between;">
        <div class="muted">Nguồn: <code id="fileIndicator">data.csv</code></div>
        <div><button class="btn" onclick="refreshStudents()">Tải lại</button></div>
      </div>
      <div class="card hint">Dùng Ctrl/Cmd + F để lọc nhanh.</div>
      <div id="studentsTable" class="card" style="margin-top:12px;overflow:auto"></div>
      <div id="studentsPager" class="card flex" style="justify-content:space-between;margin-top:8px"></div>
    </section>

    <!-- GROUP -->
    <section id="panel-group" class="panel">
      <div class="grid">
        <div class="card">
          <div class="row">
            <label>Số người mỗi nhóm (ưu tiên)</label>
            <input id="groupSize" type="number" min="2" placeholder="VD: 3" />
          </div>
          <div class="row">
            <label>Số nhóm mỗi ca (tuỳ chọn)</label>
            <input id="groupsPerCa" type="number" min="1" placeholder="VD: 3" />
          </div>
          <div class="row">
            <button id="btnRun" class="btn primary" onclick="runGrouping()">Chia nhóm</button>
            <span id="runMsg" class="msg muted"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULT -->
    <section id="panel-result" class="panel">
      <div class="card" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <div class="muted">Thành viên từng nhóm (đọc từ file kết quả của dataset đã chọn)</div>
        <div class="flex" style="gap:8px;flex-wrap:wrap">
          <input id="filterCa" placeholder="Lọc Ca (vd: Ca1)" style="width:160px" />
          <input id="filterNhom" type="number" min="1" placeholder="Lọc Nhóm (vd: 3)" style="width:160px" />
          <button class="btn" onclick="applyFilters()">Áp dụng lọc</button>
          <button class="btn" onclick="clearFilters()">Xoá lọc</button>
          <button class="btn primary" id="btnXlsx" onclick="downloadXlsx()">Tải Excel</button>
          <button class="btn" onclick="refreshResult()">Tải lại</button>
        </div>
      </div>

      <div id="membersTable" class="card" style="overflow:auto"></div>
      <div id="resultPager" class="card flex" style="justify-content:space-between;margin-top:8px"></div>
    </section>
  </div>

  <script>
    // ===== Helpers =====
    function token(){ return localStorage.getItem('ADMIN_TOKEN') || sessionStorage.getItem('ADMIN_TOKEN'); }
    function authHeader(){ return { 'X-Admin-Token': token() || '' }; }
    function ensureAuth(){ if(!token()){ alert('Chưa đăng nhập admin.'); location.href='/'; } }
    function goHome(){ location.href = '/'; }
    function logout(){ localStorage.removeItem('ADMIN_TOKEN'); sessionStorage.removeItem('ADMIN_TOKEN'); location.href='/'; }

    // dataset select
    const dsSel = document.getElementById('datasetSelect');
    dsSel.value = localStorage.getItem('DATASET') || 'data';
    dsSel.addEventListener('change', () => {
      localStorage.setItem('DATASET', dsSel.value);
      document.getElementById('fileIndicator').textContent = dsSel.value === 'data' ? 'data.csv' : 'data_h2.csv';
      refreshStudents(1);
      refreshResult(1);
    });
    document.getElementById('fileIndicator').textContent = dsSel.value === 'data' ? 'data.csv' : 'data_h2.csv';

    // Tabs
    const tabs = [
      {btn:'tab-students', panel:'panel-students'},
      {btn:'tab-group', panel:'panel-group'},
      {btn:'tab-result', panel:'panel-result'}
    ];
    tabs.forEach(t=>{
      document.getElementById(t.btn).addEventListener('click', ()=>{
        tabs.forEach(x=>{
          document.getElementById(x.btn).setAttribute('aria-selected', x.btn===t.btn ? 'true':'false');
          document.getElementById(x.panel).classList.toggle('active', x.btn===t.btn);
        });
        if(t.btn==='tab-students') refreshStudents();
        if(t.btn==='tab-result') refreshResult();
      });
    });

    // ===== Students (paging) =====
    async function refreshStudents(page=1, pageSize=25, q=''){
      ensureAuth();
      const dataset = dsSel.value;                 // <-- LẤY DATASET
      const box = document.getElementById('studentsTable');
      box.innerHTML = 'Đang tải...';

      const params = new URLSearchParams({ page, page_size: pageSize, dataset }); // <-- TRUYỀN DATASET
      if (q) params.set('q', q);

      const resp = await fetch('/api/admin/students?' + params.toString(), { headers: authHeader() });
      if(!resp.ok){ box.innerHTML = '<span class="err">Không tải được dữ liệu.</span>'; return; }
      const data = await resp.json();
      if(!data.ok){ box.innerHTML = '<span class="err">Không có dữ liệu.</span>'; return; }

      const rows = data.rows || [];
      if(rows.length===0){ box.innerHTML = '<span class="muted">Chưa có bản ghi.</span>'; return; }

      const curPage = data.page || 1;
      const pageSz  = data.page_size || rows.length;
      const total   = data.total || rows.length;
      const totalPages = data.total_pages || 1;

      const base = (curPage - 1) * pageSz; // STT liên tục
      const cols = ['#','Timestamp','Username','Mã SV','Tên','Lớp','GPA','Ca học','Công việc IT','Sở thích'];

      let html = '<table><thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
      for(let i=0;i<rows.length;i++){
        const r = rows[i];
        html += '<tr>';
        html += `<td>${base + i + 1}</td>`;
        html += `<td>${r['Timestamp']??''}</td>`;
        html += `<td>${r['Username']??''}</td>`;
        html += `<td>${r['Mã SV']??''}</td>`;
        html += `<td>${r['Tên']??''}</td>`;
        html += `<td>${r['Lớp']??''}</td>`;
        html += `<td>${r['GPA']??''}</td>`;
        html += `<td>${r['Ca học']??''}</td>`;
        html += `<td>${r['Công việc IT']??''}</td>`;
        html += `<td>${r['Sở thích']??''}</td>`;
        html += '</tr>';
      }
      html += '</tbody></table>';

      html += `
        <div style="display:flex;align-items:center;gap:8px;justify-content:flex-end;margin-top:10px">
          <span class="muted">Trang ${curPage}/${totalPages} • Tổng ${total}</span>
          <button class="btn" ${curPage<=1?'disabled':''}
            onclick="refreshStudents(${curPage-1}, ${pageSz})">« Trước</button>
          <button class="btn" ${curPage>=totalPages?'disabled':''}
            onclick="refreshStudents(${curPage+1}, ${pageSz})">Sau »</button>
        </div>`;
      box.innerHTML = html;
    }

    // ===== Grouping =====
    async function runGrouping(){
      ensureAuth();
      const dataset = dsSel.value;
      const btn = document.getElementById('btnRun');
      const msg = document.getElementById('runMsg');
      msg.className='msg muted'; msg.textContent=''; btn.disabled = true;

      const groupSize = document.getElementById('groupSize').value.trim();
      const groupsPerCa = document.getElementById('groupsPerCa').value.trim();

      const params = new URLSearchParams();
      params.set('dataset', dataset);
      if(groupSize) params.set('group_size', groupSize);
      if(!groupSize && groupsPerCa) params.set('groups_per_ca', groupsPerCa);

      const resp = await fetch('/api/admin/group/run?' + params.toString(), { method:'POST', headers: { ...authHeader() } });
      const data = await resp.json().catch(()=>null);
      if(!resp.ok || !data?.ok){ msg.className='msg err'; msg.textContent = data?.message || 'Chia nhóm thất bại.'; }
      else { msg.className='msg ok'; msg.textContent = 'Đã chia nhóm (lưu theo dataset đã chọn). Vào tab "Kết quả" để xem.'; refreshResult(1); }
      btn.disabled = false;
    }

    // ===== Result (paging + filters + download) =====
    let _resultFilters = { ca: '', nhom: '' };

    function getResultFilters(){
      const ca = (document.getElementById('filterCa').value || '').trim();
      const nhom = (document.getElementById('filterNhom').value || '').trim();
      return { ca, nhom };
    }
    function applyFilters(){
      _resultFilters = getResultFilters();
      refreshResult(1);
    }
    function clearFilters(){
      document.getElementById('filterCa').value = '';
      document.getElementById('filterNhom').value = '';
      _resultFilters = { ca:'', nhom:'' };
      refreshResult(1);
    }

    async function refreshResult(page=1){
      ensureAuth();
      const dataset = dsSel.value;
      const box = document.getElementById('membersTable');
      const pager = document.getElementById('resultPager');
      box.innerHTML = 'Đang tải...'; pager.innerHTML='';

      const params = new URLSearchParams({ dataset, page, page_size: 25 });
      if(_resultFilters.ca) params.set('ca', _resultFilters.ca);
      if(_resultFilters.nhom) params.set('nhom', _resultFilters.nhom);

      const resp = await fetch(`/api/admin/group/result?${params.toString()}`, { headers: authHeader() });
      const data = await resp.json().catch(()=>null);

      if(!resp.ok || !data?.ok){
        box.innerHTML = '<span class="muted">Chưa có kết quả. Hãy vào tab "Chia nhóm" và chạy chia nhóm.</span>';
        return;
      }
      const rows = data.rows || [];
      const cols = ['Mã SV','Tên','Lớp','Ca','GPA','Nhóm','GPA TB Nhóm'];
      let html = '<table><thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
      for(const r of rows){ html += '<tr>' + cols.map(c=>`<td>${(r[c]??'')}</td>`).join('') + '</tr>'; }
      html += '</tbody></table>';
      box.innerHTML = html;

      pager.innerHTML = pageButtons(data.page, data.total_pages, p=>refreshResult(p));
    }

    function pageButtons(page, total, onClick){
      const prev = Math.max(1, page-1), next = Math.min(total, page+1);
      return `<div>Trang ${page}/${total}</div>
              <div class="flex right">
                <button class="btn" ${page<=1?'disabled':''} onclick="(${onClick})(1)">«</button>
                <button class="btn" ${page<=1?'disabled':''} onclick="(${onClick})(${prev})">‹</button>
                <button class="btn" ${page>=total?'disabled':''} onclick="(${onClick})(${next})">›</button>
                <button class="btn" ${page>=total?'disabled':''} onclick="(${onClick})(${total})">»</button>
              </div>`;
    }

    // === Download XLSX ===
    function _filenameFromDisposition(dispo, fallback){
      try{
        if(!dispo) return fallback;
        const m = /filename\*=UTF-8''([^;]+)|filename="([^"]+)"/i.exec(dispo);
        if(m){
          const name = decodeURIComponent(m[1] || m[2]);
          return name || fallback;
        }
      }catch(e){}
      return fallback;
    }

    async function downloadXlsx(){
      ensureAuth();
      const dataset = dsSel.value;
      const btn = document.getElementById('btnXlsx');
      const old = btn.textContent;
      btn.textContent = 'Đang tạo...'; btn.disabled = true;

      const params = new URLSearchParams({ dataset });
      const { ca, nhom } = getResultFilters();
      if(ca) params.set('ca', ca);
      if(nhom) params.set('nhom', nhom);

      try{
        const resp = await fetch(`/api/admin/group/result.xlsx?${params.toString()}`, {
          headers: { ...authHeader() }
        });
        if(!resp.ok){
          const errTxt = await resp.text().catch(()=> '');
          alert('Xuất Excel thất bại: ' + (errTxt || resp.status));
          return;
        }
        const blob = await resp.blob();
        const dispo = resp.headers.get('content-disposition');
        const fallback = `ket_qua_${dataset}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.xlsx`;
        const filename = _filenameFromDisposition(dispo, fallback);

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
      }catch(e){
        alert('Lỗi tải file: ' + e.message);
      }finally{
        btn.textContent = old; btn.disabled = false;
      }
    }

    // init
    ensureAuth();
    refreshStudents();
  </script>
</body>
</html>
